trigger:
- master

resources:
- repo: self

variables:
  dockerRegistryServiceConnection: 'd932d5a2-7e91-48b9-b339-918c998b3ae9'
  containerRegistry: 'freshersparkregistry.azurecr.io'
  
  # RabbitMQ variables
  rabbitmqImageRepository: 'freshersparkrabbitmq'
  rabbitmqDockerfilePath: '$(Build.SourcesDirectory)/Dockerfile.rabbitmq'
  
  tag: '$(Build.BuildId)'
  vmImageName: 'ubuntu-latest'

stages:
- stage: Build
  displayName: Build and push RabbitMQ image
  jobs:
  - job: BuildRabbitMQ
    displayName: Build RabbitMQ Image
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: Docker@2
      displayName: Build and push RabbitMQ image
      inputs:
        command: buildAndPush
        repository: $(rabbitmqImageRepository)
        dockerfile: $(rabbitmqDockerfilePath)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)
          latest
        buildContext: '$(Build.SourcesDirectory)'

- stage: Deploy
  displayName: Deploy RabbitMQ with Key Vault
  dependsOn: Build
  jobs:
  - job: DeployRabbitMQ
    displayName: Deploy RabbitMQ
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: AzureCLI@2
      displayName: 'Deploy RabbitMQ to Container Apps'
      inputs:
        azureSubscription: '8ce37efe-06df-47c4-b146-001d3ddfb1ba'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          # Update container app with proper ports configuration
          az containerapp update \
            --name freshersparkrabbitmq \
            --resource-group freshersparkresource \
            --image $(containerRegistry)/$(rabbitmqImageRepository):$(tag) \
            --container-name rabbitmq \
            --set properties.template.containers[0].ports='[{"port": 5672}, {"port": 15672}]'
          
          # Configure ingress for management UI
          az containerapp ingress update \
            --name freshersparkrabbitmq \
            --resource-group freshersparkresource \
            --type external \
            --target-port 15672 \
            --transport auto
          
          # Assign managed identity (if using Key Vault)
          az containerapp identity assign \
            --name freshersparkrabbitmq \
            --resource-group freshersparkresource